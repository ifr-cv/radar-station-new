# 厦门理工学院PFA战队单目相机雷达站算法开源（含机器人、装甲板识别模型）
 **【已更新最新的串口通信协议，国赛即插即用！！！】** 


【全场透视！979.6s有效标记定位！｜厦门理工学院雷达机器人研发方案分享】 https://www.bilibili.com/video/BV1jD421g7ab/


【RoboMaster2024青年工程师大会｜厦门理工学院雷达视觉算法设计思路分享】 https://www.bilibili.com/video/BV1uJ4m137uh/

#### 功能介绍

基于此算法，使用 **任意单目相机** 和 **任意运算端** ，即可实现 **雷达站的所有功能** ，主要功能如下：
1. 机器人精确定位
2. 视野盲区预测（辽科雷达方案优化）
3. 标记进度显示
4. 自主发动双倍易伤
5. 裁判系统双向通信
6. 支持USB相机和海康相机


#### 效果展示
1. 场均标点**全国一等奖**
![全国雷达排名第一](images/%E5%85%A8%E5%9B%BD%E7%AC%AC%E4%B8%80.JPG)
2. 南部赛区累计标点数第三
![南部雷达](images/image1.jpg)
3. 比赛大部分时间全场高亮、主动发动双倍易伤
![双倍易伤](images/image2.png)
![全场高亮](images/image4.jpg)


#### 软件依赖
1. Python3.9
2. Windows10、Linux（Ubuntu支持，其他Linux系统可能需要适配）


#### 硬件要求
1. 海康工业相机/USB直驱相机/大恒相机
2. USB串口（另一头需接裁判系统user串口）
3. 有GPU的运算端，推荐RTX3060以上
4. 推荐配置：相机MV-CS060-10UC-PRO（USB款），镜头5-12ｍｍ（6ｍｍ最佳）
![硬件推荐](images/image6.JPG)


#### 配置环境
1.  pip install -r requirements.txt 
2.  如需加速模型推理，请安装tensorrt版本8.6.1（安装教程网上有）
3.  安装好tensorrt后，运行onnx2engine.py,模型转换完成后，修改main.py 621行，更换为engine模型
4.  如需使用海康相机，请先安装好对应平台的MVS客户端，测试相机通过后再运行本项目


#### 标定指南
1. 每场比赛开始前，需对雷达进行标定，使用calibration.py 脚本，先修改参数后运行。
2. 选择标定模式（test':测试模式,'hik':海康相机,'video':USB相机（videocapture）），己方阵营（test模式只能为蓝方），calibration.py 360、362行
3. 运行calibration.py，将相机视角调节合适后，点击“开始标定”
4. 依次点击相机视图和地图视图 **地面** 对应对应的四组、八个点（白色）后，点击切换高度
5. 依次点击相机视图和地图视图 **R型高地** 对应对应的四组、八个点（绿色）后，点击切换高度
6. 依次点击相机视图和地图视图 **环型高地** 对应对应的四组、八个点后（蓝色），点击保存计算
![标定演示](images/calibration.JPG)


#### 运行指南（标定完成后）
1. 更改main.py 628行的串口名（不使用串口测试的话请注释628-635行，这部分为串口收发线程）
2. 修改运行模式---'test':测试模式,'hik':海康相机,'video':USB相机（videocapture）main.py 627行，默认为test
3. 修改己方阵营，test模式只能为蓝方，main.py 17行
4. 运行main.py文件，出现如下图所示则运行成功（标记进度全为-1表示没有连接到裁判系统）
![运行图例](images/image3.JPG)
5. 在云台手端，切换飞镖锁定目标触发双倍易伤
6. 如果运行帧率太低，1fps左右，考虑是torch或者onnx没有安装GPU版本，如果不行，请转换为trt模型加速推理


###更多
1.把文档转移到本地(windows)之后，照着上面的做就行，可以直接使用大恒相机，具体相机参数可以在代码中调整，也可以在Galaxy.Viewer里面调。
2.把这些放到服务器主机(linux)的虚拟环境之后，需根据主机的nvidia版本下载pytorch的cuda加速版。


